<template>
  <div class="post-list">
    <div v-if="loading" class="loading-container">
      <div class="masonry-skeleton">
        <div v-for="i in 9" :key="i" class="skeleton-item">
          <el-skeleton :rows="5" animated />
        </div>
      </div>
    </div>
    
    <div v-else-if="posts.length === 0" class="empty-container">
      <el-empty description="No content yet" :image-size="120">
        <template #image>
          <div class="empty-image">ğŸ“</div>
        </template>
        <el-button type="primary" @click="$router.push('/post/create')" size="large">
          <el-icon><Plus /></el-icon>
          Create Your First Post
        </el-button>
      </el-empty>
    </div>
    
    <div v-else class="posts-masonry-container">
      <!-- èˆ’é€‚èƒŒæ™¯çš„ä¸‰åˆ—ç€‘å¸ƒæµå¸ƒå±€ -->
      <div 
        ref="masonryContainer" 
        class="masonry-grid"
        :class="`columns-${currentColumns}`"
      >
        <div
          v-for="(column, columnIndex) in columnPosts"
          :key="`column-${columnIndex}`"
          class="masonry-column"
        >
          <div
            v-for="post in column"
            :key="post.id"
            class="masonry-item"
            :style="{ animationDelay: `${post.animationDelay}ms` }"
          >
            <PostCard 
              :post="post" 
              @post-deleted="handlePostDeleted"
              @post-updated="handlePostUpdated"
            />
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, computed, watch, onMounted, onBeforeUnmount, nextTick } from 'vue'
import PostCard from './PostCard.vue'
import { Plus } from '@element-plus/icons-vue'

const props = defineProps({
  posts: {
    type: Array,
    default: () => []
  },
  loading: {
    type: Boolean,
    default: false
  }
})

const emit = defineEmits(['post-deleted', 'post-updated'])

// å“åº”å¼åˆ—æ•°
const masonryContainer = ref(null)
const screenWidth = ref(window.innerWidth)
const currentColumns = ref(3)

// æ ¹æ®å±å¹•å®½åº¦è®¡ç®—åˆ—æ•°
const calculateColumns = () => {
  const width = screenWidth.value
  if (width < 768) return 1
  if (width < 1024) return 2
  return 3
}

// ç€‘å¸ƒæµåˆ—æ•°æ®
const columnPosts = computed(() => {
  const columns = currentColumns.value
  const result = Array.from({ length: columns }, () => [])
  const columnHeights = new Array(columns).fill(0)
  
  props.posts.forEach((post, index) => {
    // æ™ºèƒ½è®¡ç®—å¸–å­é«˜åº¦ï¼ˆåŸºäºçœŸå®å†…å®¹ï¼‰
    const estimatedHeight = calculatePostHeight(post)
    
    // æ‰¾åˆ°å½“å‰æœ€çŸ­çš„åˆ—
    const shortestColumnIndex = columnHeights.indexOf(Math.min(...columnHeights))
    
    // æ·»åŠ åŠ¨ç”»å»¶è¿Ÿ
    const postWithDelay = {
      ...post,
      animationDelay: index * 100
    }
    
    // å°†å¸–å­åˆ†é…åˆ°æœ€çŸ­åˆ—
    result[shortestColumnIndex].push(postWithDelay)
    columnHeights[shortestColumnIndex] += estimatedHeight
  })
  
  return result
})

// æ™ºèƒ½è®¡ç®—å¸–å­é«˜åº¦ï¼ˆåŸºäºå†…å®¹ç±»å‹å’Œå›¾ç‰‡å°ºå¯¸ï¼‰
const calculatePostHeight = (post) => {
  let height = 250 // åŸºç¡€é«˜åº¦: å¤´éƒ¨+æ ‡é¢˜+æ“ä½œæ 
  
  // æè¿°æ–‡å­—
  if (post.description) {
    height += Math.min(post.description.length * 1.2, 120)
  }
  
  // æ–‡å­—å†…å®¹
  if (post.content_text) {
    const textLines = Math.ceil(post.content_text.length / 50)
    height += Math.min(textLines * 32, 200)
  }
  
  // æ™ºèƒ½å›¾ç‰‡é«˜åº¦è®¡ç®—
  if (post.media && post.media.length > 0) {
    const imageCount = post.media.filter(m => m.media_type === 'image').length
    if (imageCount > 0) {
      if (imageCount === 1) {
        // å•å›¾: ä½¿ç”¨æ ‡å‡†å±•ç¤ºå°ºå¯¸
        height += 300
      } else if (imageCount === 2) {
        // åŒå›¾: ä¸¤å¼ å›¾å„è‡ªæŒ‰å•å›¾å°ºå¯¸å‚ç›´æ’åˆ—
        height += 600 // 300 * 2ï¼Œè®©ä¸¤å¼ å›¾éƒ½æœ‰å®Œæ•´å°ºå¯¸
      } else if (imageCount === 3) {
        // ä¸‰å›¾: 1å¤§+2å°å¸ƒå±€
        height += 320
      } else {
        // å¤šå›¾: ç´§å‡‘ç½‘æ ¼å¸ƒå±€
        height += 280
      }
    }
    
    // éŸ³é¢‘å†…å®¹
    const audioCount = post.media.filter(m => m.media_type === 'audio').length
    height += audioCount * 70
  }
  
  // è½¬å‘å†…å®¹é¢å¤–é«˜åº¦
  if (post.is_repost) {
    height += 120
    if (post.repost_comment) height += 80
  }
  
  return height + Math.random() * 40
}

// çª—å£å¤§å°å˜åŒ–ç›‘å¬
const handleResize = () => {
  screenWidth.value = window.innerWidth
  const newColumns = calculateColumns()
  if (newColumns !== currentColumns.value) {
    currentColumns.value = newColumns
  }
}

// ä¼ é€’äº‹ä»¶åˆ°çˆ¶ç»„ä»¶
const handlePostDeleted = (postId) => {
  console.log('PostList: Handling post deletion:', postId)
  emit('post-deleted', postId)
}

const handlePostUpdated = (updateData) => {
  console.log('PostList: Handling post update:', updateData)
  emit('post-updated', updateData)
}

// ç›‘å¬postså˜åŒ–é‡æ–°å¸ƒå±€
watch(() => props.posts, () => {
  nextTick(() => {
    console.log('Posts updated, recalculating masonry layout')
  })
}, { deep: true })

onMounted(() => {
  currentColumns.value = calculateColumns()
  window.addEventListener('resize', handleResize)
})

onBeforeUnmount(() => {
  window.removeEventListener('resize', handleResize)
})
</script>

<style lang="scss" scoped>
.post-list {
  width: 100%;
  min-height: 600px;
  // èˆ’é€‚çš„æµ…ç°èƒŒæ™¯ï¼ŒæŠ¤çœ¼
  background: transparent;
}

// åŠ è½½çŠ¶æ€ - èˆ’é€‚èƒŒæ™¯
.loading-container {
  .masonry-skeleton {
    display: grid;
    gap: 36px;
    
    // æ¡Œé¢ä¸‰åˆ—
    @media (min-width: 1024px) {
      grid-template-columns: repeat(3, 1fr);
    }
    
    // å°å¹³æ¿åŒåˆ—
    @media (min-width: 768px) and (max-width: 1023px) {
      grid-template-columns: repeat(2, 1fr);
    }
    
    // æ‰‹æœºå•åˆ—
    @media (max-width: 767px) {
      grid-template-columns: 1fr;
    }
    
    .skeleton-item {
      background: white;
      border-radius: 20px;
      padding: 28px;
      box-shadow: 0 6px 24px rgba(0, 0, 0, 0.06);
      border: 1px solid rgba(0, 0, 0, 0.03);
      min-height: 350px;
    }
  }
}

// ç©ºçŠ¶æ€
.empty-container {
  padding: 80px 20px;
  text-align: center;
  background: white;
  border-radius: 20px;
  margin: 20px 0;
  box-shadow: 0 6px 24px rgba(0, 0, 0, 0.06);
  
  .empty-image {
    font-size: 60px;
    margin-bottom: 16px;
    opacity: 0.6;
  }
}

// ä¸‰åˆ—ç€‘å¸ƒæµå®¹å™¨ - èˆ’é€‚çš„è§†è§‰é—´è·
.posts-masonry-container {
  width: 100%;
  padding: 8px;
  // ä½¿ç”¨å¾®å¦™çš„èƒŒæ™¯æ¸å˜æå‡è§†è§‰å±‚æ¬¡
  background: transparent;
  
  .masonry-grid {
    display: flex;
    align-items: flex-start;
    gap: 36px;
    
    // æ¡Œé¢ä¸‰åˆ—
    &.columns-3 {
      .masonry-column {
        width: calc(33.333% - 24px);
      }
    }
    
    // å¹³æ¿åŒåˆ—
    &.columns-2 {
      .masonry-column {
        width: calc(50% - 18px);
      }
    }
    
    // æ‰‹æœºå•åˆ—
    &.columns-1 {
      .masonry-column {
        width: 100%;
      }
    }
    
    .masonry-column {
      display: flex;
      flex-direction: column;
      gap: 36px;
      
      .masonry-item {
        width: 100%;
        opacity: 0;
        transform: translateY(30px);
        animation: fadeInUp 0.7s ease forwards;
        
        // ç²¾è‡´çš„æ‚¬åœæ•ˆæœ
        &:hover {
          transform: translateY(-12px) scale(1.02);
          transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
          
          :deep(.post-card) {
            box-shadow: 0 24px 80px rgba(0, 0, 0, 0.15);
            border: 1px solid rgba(64, 158, 255, 0.2);
          }
        }
      }
    }
  }
}

// PostCardæ ·å¼ä¼˜åŒ– - é‡ç‚¹ä¿®å¤å›¾ç‰‡æ˜¾ç¤º
.masonry-item :deep(.post-card) {
  padding: 32px;
  border-radius: 24px;
  min-height: 200px;
  background: #ffffff;
  border: 1px solid rgba(0, 0, 0, 0.04);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
  position: relative;
  overflow: hidden;
  
  // ç»†å¾®è£…é¥°æ•ˆæœ
  &::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 1px;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.9), transparent);
    pointer-events: none;
  }
  
  // ç”¨æˆ·ä¿¡æ¯åŒºåŸŸ
  .user-info {
    margin-bottom: 24px;
    
    .el-avatar {
      width: 48px !important;
      height: 48px !important;
      border: 2px solid rgba(255, 255, 255, 0.9);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }
    
    .user-details {
      margin-left: 12px;
      
      .username {
        font-size: 17px !important;
        font-weight: 700 !important;
        color: #1a1a1a !important;
        margin-bottom: 2px;
      }
      
      .time {
        font-size: 14px !important;
        color: #6b7280 !important;
      }
    }
  }
  
  // æ ‡é¢˜å’Œæè¿°
  .post-title {
    font-size: 24px !important;
    margin-bottom: 16px !important;
    line-height: 1.3 !important;
    color: #111827 !important;
    font-weight: 800 !important;
  }
  
  .post-description {
    font-size: 17px !important;
    margin-bottom: 20px !important;
    line-height: 1.6 !important;
    color: #4b5563 !important;
  }
  
  // æ–‡å­—å†…å®¹
  .post-text {
    padding: 24px !important;
    margin-bottom: 24px !important;
    background: #f8fafc !important;
    border-radius: 16px !important;
    border: 1px solid rgba(0, 0, 0, 0.03);
    
    p {
      font-size: 17px !important;
      line-height: 1.7 !important;
      color: #1f2937 !important;
    }
  }
  
  // ğŸ–¼ï¸ é‡ç‚¹ä¼˜åŒ–ï¼šå›¾ç‰‡åŒºåŸŸæ™ºèƒ½æ˜¾ç¤º
  .post-media {
    margin-bottom: 24px !important;
    
    .images-section {
      margin-bottom: 20px !important;
      
      .images-grid {
        gap: 16px !important;
        border-radius: 20px !important;
        overflow: hidden;
        
        // å•å›¾ - æ ‡å‡†å±•ç¤ºå°ºå¯¸
        &.single-image {
          .image-item {
            .media-image {
              width: 100% !important;
              min-height: 280px !important;
              max-height: 500px !important; // å¢åŠ æœ€å¤§é«˜åº¦é€‚é…é•¿å›¾
              border-radius: 20px;
              
              :deep(.el-image__inner) {
                object-fit: contain !important; // ä¿æŒå®Œæ•´å›¾ç‰‡ï¼Œä¸è£å‰ª
                width: 100%;
                height: 100%;
              }
            }
          }
        }
        
        // ğŸ¯ åŒå›¾ - æŒ‰å•å›¾å°ºå¯¸å‚ç›´å¹¶åˆ—æ˜¾ç¤º
        &.two-images {
          display: flex !important;
          flex-direction: column !important; // å‚ç›´æ’åˆ—
          gap: 20px !important; // å¢åŠ é—´è·
          
          .image-item {
            width: 100% !important;
            
            .media-image {
              width: 100% !important;
              min-height: 280px !important; // ä¸å•å›¾ç›¸åŒé«˜åº¦
              max-height: 480px !important; // ä¸å•å›¾ç›¸ä¼¼çš„æœ€å¤§é«˜åº¦
              border-radius: 16px;
              
              :deep(.el-image__inner) {
                object-fit: contain !important; // å®Œæ•´æ˜¾ç¤ºï¼Œä¸è£å‰ª
                width: 100%;
                height: 100%;
              }
            }
          }
        }
        
        // ä¸‰å›¾å¸ƒå±€ - 1å¤§2å°
        &.three-images {
          display: grid !important;
          grid-template-columns: 1fr 1fr !important;
          gap: 12px !important;
          
          .image-item:first-child {
            grid-row: span 2;
            
            .media-image {
              height: 300px !important;
              border-radius: 16px;
              
              :deep(.el-image__inner) {
                object-fit: cover !important;
              }
            }
          }
          
          .image-item:not(:first-child) .media-image {
            height: 144px !important;
            border-radius: 12px;
            
            :deep(.el-image__inner) {
              object-fit: cover !important;
            }
          }
        }
        
        // å››å›¾åŠä»¥ä¸Š - ç´§å‡‘ç½‘æ ¼
        &.four-images, &.many-images {
          display: grid !important;
          grid-template-columns: 1fr 1fr !important;
          gap: 12px !important;
          
          .image-item .media-image {
            height: 160px !important;
            border-radius: 12px;
            
            :deep(.el-image__inner) {
              object-fit: cover !important;
            }
          }
        }
        
        // æ‰€æœ‰å›¾ç‰‡é€šç”¨æ ·å¼
        .image-item {
          border-radius: 16px;
          overflow: hidden;
          background: #f3f4f6;
          
          .media-image {
            transition: all 0.3s ease;
            cursor: pointer;
            
            &:hover {
              transform: scale(1.02);
            }
            
            // é•¿å›¾å’Œç‰¹æ®Šå°ºå¯¸ä¼˜åŒ–
            :deep(.el-image__inner) {
              display: block;
              // å¯¹äºé•¿å›¾ï¼Œç¡®ä¿å®Œæ•´æ˜¾ç¤º
              max-width: 100%;
              height: auto;
            }
            
            // åŠ è½½é”™è¯¯æ—¶çš„æ ·å¼
            :deep(.el-image__error) {
              background: #f8f9fa;
              display: flex;
              align-items: center;
              justify-content: center;
              color: #909399;
              font-size: 14px;
              min-height: 200px;
            }
          }
        }
      }
    }
    
    // éŸ³é¢‘æ’­æ”¾å™¨
    .audio-section .audio-item .audio-player {
      height: 52px !important;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
    }
  }
  
  // æ“ä½œæŒ‰é’®
  .post-actions {
    padding-top: 24px !important;
    gap: 32px !important;
    border-top: 1px solid rgba(0, 0, 0, 0.04);
    
    .action-button {
      font-size: 16px !important;
      padding: 10px 20px !important;
      border-radius: 12px !important;
      transition: all 0.3s ease;
      
      &:hover {
        background: rgba(64, 158, 255, 0.08) !important;
      }
    }
  }
  
  // è½¬å‘ç›¸å…³æ ·å¼
  .repost-header {
    margin-bottom: 20px !important;
    padding-bottom: 16px !important;
    font-size: 15px !important;
    border-bottom: 1px solid rgba(0, 0, 0, 0.04);
  }
  
  .repost-comment .repost-comment-content {
    padding: 20px !important;
    background: #f1f5f9 !important;
    border-radius: 16px;
    border: 1px solid rgba(0, 0, 0, 0.02);
    
    .comment-text {
      font-size: 16px !important;
      color: #334155 !important;
    }
  }
  
  .original-post.is-repost {
    padding: 24px !important;
    background: #fafbfc !important;
    border-radius: 16px;
    border: 1px solid rgba(0, 0, 0, 0.02);
  }
}

// å…¥åœºåŠ¨ç”»
@keyframes fadeInUp {
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

// å“åº”å¼ä¼˜åŒ–
@media (max-width: 1024px) {
  .posts-masonry-container {
    padding: 6px;
    
    .masonry-grid {
      gap: 28px;
      
      .masonry-column {
        gap: 28px;
      }
    }
  }
  
  .masonry-item :deep(.post-card) {
    padding: 28px;
    
    .post-title {
      font-size: 22px !important;
    }
  }
}

@media (max-width: 768px) {
  .posts-masonry-container {
    padding: 4px;
    
    .masonry-grid {
      gap: 24px;
      
      .masonry-column {
        gap: 24px;
        width: 100% !important;
      }
    }
  }
  
  .loading-container {
    .masonry-skeleton {
      gap: 24px;
      
      .skeleton-item {
        padding: 24px;
        min-height: 300px;
      }
    }
  }
  
  .masonry-item :deep(.post-card) {
    padding: 24px;
    border-radius: 20px;
    
    // æ‰‹æœºç«¯å›¾ç‰‡ä¼˜åŒ–
    .post-media .images-section .images-grid {
      &.single-image .image-item .media-image {
        min-height: 250px !important;
        max-height: 400px !important;
      }
      
      &.two-images .image-item .media-image {
        min-height: 220px !important;
        max-height: 350px !important;
      }
    }
  }
}

// æ€§èƒ½ä¼˜åŒ–
.masonry-grid {
  transform: translateZ(0);
  will-change: auto;
  transition: all 0.3s ease;
}

.masonry-column {
  transform: translateZ(0);
  transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.masonry-item {
  contain: layout style paint;
  transform: translateZ(0);
}

// æ·±è‰²æ¨¡å¼é€‚é…
@media (prefers-color-scheme: dark) {
  .post-list {
    background: #0f1419;
  }
  
  .masonry-item :deep(.post-card) {
    background: #1f2937 !important;
    border: 1px solid rgba(255, 255, 255, 0.08) !important;
    color: #f9fafb !important;
    
    .post-title {
      color: #f9fafb !important;
    }
    
    .post-text {
      background: #111827 !important;
      border: 1px solid rgba(255, 255, 255, 0.06) !important;
    }
  }
}
</style>
